<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Emergency Alert App</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0f2f7 0%, #c1e0ed 100%);
      -webkit-tap-highlight-color: transparent;
    }
    .emergency-btn {
      transition: all 0.2s ease;
    }
    .emergency-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .emergency-btn:active {
      transform: translateY(0);
    }
    .alert-card {
      transition: background-color 0.3s ease;
    }
    .alert-card:hover {
      background-color: #f8fafc;
    }
    #previousAlerts::-webkit-scrollbar, #chatMessages::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    #previousAlerts::-webkit-scrollbar-track, #chatMessages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    #previousAlerts::-webkit-scrollbar-thumb, #chatMessages::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
    #previousAlerts::-webkit-scrollbar-thumb:hover, #chatMessages::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
    }
    /* Mobile-specific optimizations */
    @media (max-width: 640px) {
      .text-lg {
        font-size: 1.125rem;
      }
      .text-xl {
        font-size: 1.25rem;
      }
      .text-2xl {
        font-size: 1.5rem;
      }
      .text-3xl {
        font-size: 1.75rem;
      }
      .p-6 {
        padding: 1rem;
      }
      .p-8 {
        padding: 1.25rem;
      }
      .py-6 {
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      .px-6 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .max-w-md {
        max-width: 100%;
      }
      .rounded-xl {
        border-radius: 0.75rem;
      }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 sm:p-4">
  <div id="app" class="w-full max-w-md mx-auto">
    <!-- Login Section -->
    <div id="loginSection" class="bg-white rounded-xl shadow-2xl overflow-hidden transform transition-all duration-300 ease-in-out">
      <div class="bg-gradient-to-r from-blue-600 to-blue-800 py-4 px-4 sm:py-6 sm:px-6 flex flex-col items-center justify-center">
        <span class="material-symbols-outlined text-white text-4xl sm:text-5xl mb-1 sm:mb-2">
          emergency
        </span>
        <h2 class="text-2xl sm:text-3xl font-bold text-white text-center tracking-wide">Emergency Alert</h2>
        <p class="text-blue-100 text-xs sm:text-sm mt-1">Stay safe, stay connected</p>
      </div>
      <div class="p-4 sm:p-6">
        <div class="mb-4">
          <label for="userName" class="block text-sm font-medium text-gray-700 mb-1 sm:mb-2">Your Name</label>
          <input id="userName" type="text" placeholder="Enter Your Name"
                 class="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out">
        </div>
        <div class="mb-5">
          <label for="mobile" class="block text-sm font-medium text-gray-700 mb-1 sm:mb-2">Mobile Number</label>
          <input id="mobile" type="tel" placeholder="Enter 10-digit Mobile Number" maxlength="10" 
                 class="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out"
                 inputmode="numeric">
        </div>
        <button onclick="loginUser()" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 sm:py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out emergency-btn">
          Continue
        </button>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="bg-blue-600 py-3 px-4 sm:py-4 sm:px-6 flex justify-between items-center">
        <h2 class="text-lg sm:text-xl font-bold text-white">Emergency Dashboard</h2>
        <button onclick="logoutUser()" class="bg-blue-700 hover:bg-blue-800 text-white text-xs sm:text-sm font-medium py-1 px-3 sm:py-2 sm:px-4 rounded-lg transition emergency-btn">
          Logout
        </button>
      </div>
      
      <div class="p-3 sm:p-4">
        <!-- Admin Banner -->
        <div id="adminBanner" class="hidden bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-3 mb-4 rounded-lg">
          <p class="font-bold text-xs sm:text-sm">Important Message from Admin:</p>
          <p id="bannerMessage" class="text-xs sm:text-sm mt-1"></p>
        </div>

        <!-- User Welcome -->
        <div class="mb-4 text-center">
          <p class="text-sm sm:text-base text-gray-600">Welcome back,</p>
          <p id="userMobile" class="text-base sm:text-lg font-semibold text-gray-800 truncate px-2"></p>
        </div>

        <!-- Emergency Buttons -->
        <div class="space-y-2 mb-4">
          <button id="dangerAlertBtn" onclick="initiateAlert('danger')" 
                  class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 sm:py-3 px-4 rounded-lg transition emergency-btn flex items-center justify-center">
            <span class="mr-2">🚨</span> I Am In Danger
          </button>
          <button id="callAlertBtn" onclick="initiateAlert('call')" 
                  class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 sm:py-3 px-4 rounded-lg transition emergency-btn flex items-center justify-center">
            <span class="mr-2">📞</span> I Need A Call
          </button>
          <button id="customAlertToggleBtn" onclick="toggleCustomMessageInput()" 
                  class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 sm:py-3 px-4 rounded-lg transition emergency-btn flex items-center justify-center">
            <span class="mr-2">🆘</span> Custom Help Request
          </button>
          
          <!-- Custom Message Input -->
          <div id="customMessageInput" class="hidden mt-2 bg-gray-50 p-3 rounded-lg">
            <textarea id="customMessage" class="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition" 
                      rows="3" placeholder="Describe your emergency..."></textarea>
            <button id="sendCustomAlertBtn" onclick="initiateAlert('custom')" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg mt-2 transition emergency-btn">
              Send Custom Alert
            </button>
          </div>
        </div>

        <!-- Countdown and Status -->
        <div id="countdownDisplay" class="text-center text-base sm:text-lg font-bold text-red-600 mb-3 hidden"></div>
        <div id="alertStatus" class="text-center mb-4 text-xs sm:text-sm font-medium hidden transition-opacity duration-500"></div>

        <!-- Previous Alerts -->
        <div class="mb-3">
          <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 mr-1 sm:mr-2 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
            </svg>
            Previous Alerts
          </h3>
          <div id="previousAlerts" class="border border-gray-200 rounded-lg p-2 bg-gray-50 max-h-40 sm:max-h-64 overflow-y-auto text-xs sm:text-sm">
            <p class="text-gray-500 text-center py-3">No previous alerts.</p>
          </div>
        </div>

        <!-- Admin Chat -->
        <div class="mb-3">
          <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2 flex items-center">
            <span class="material-symbols-outlined mr-1 sm:mr-2 text-gray-600 text-base sm:text-lg">chat</span>
            Admin Chat
          </h3>
          <div id="chatMessages" class="border border-gray-200 rounded-lg p-2 bg-gray-50 max-h-40 sm:max-h-64 overflow-y-auto mb-2 text-xs sm:text-sm">
            <p class="text-gray-500 text-center py-3">No messages yet.</p>
          </div>
          <div class="flex">
            <input type="text" id="chatMessageInput" placeholder="Type your message..."
                   class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-xs sm:text-sm">
            <button onclick="sendChatMessage()" id="sendChatMessageBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 sm:px-4 rounded-r-lg transition emergency-btn text-xs sm:text-sm">
              Send
            </button>
          </div>
        </div>

        <!-- Footer Note -->
        <p class="text-2xs sm:text-xs text-gray-500 text-center mt-4">
          <strong>Important Note:</strong> This app is for emergency use only. Misuse may result in legal action.
        </p>
      </div>
    </div>

    <!-- User Message Box -->
    <div id="userMessageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl hidden z-50 transition-opacity duration-300 opacity-0 text-sm max-w-xs">
      <p id="userMessageText"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, query, orderByChild, limitToLast, update, push } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClBohbm2-pReGrbNMsm7ttDvwM2wEIfEo",
      authDomain: "miner-5939b.firebaseapp.com",
      databaseURL: "https://miner-5939b-default-rtdb.firebaseio.com",
      projectId: "miner-5939b",
      storageBucket: "miner-5939b.firebasestorage.app",
      messagingSenderId: "936240933139",
      appId: "1:936240933139:web:fe877e387fc82951d552e6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let latestLocation = null;
    let countdownInterval;
    let currentAlertType = null;

    const alertStatusElement = document.getElementById("alertStatus");
    const adminBannerElement = document.getElementById("adminBanner");
    const bannerMessageElement = document.getElementById("bannerMessage");
    const userMessageBox = document.getElementById("userMessageBox");
    const userMessageText = document.getElementById("userMessageText");
    const countdownDisplay = document.getElementById("countdownDisplay");

    const userNameInput = document.getElementById("userName");
    
    const policeStationsData = [
      {
        "name": "Kamrup Metro (Guwahati)",
        "control": "(0361) 2540278, 2546286 (City PCR)",
        "station": "Panbazar PS: 0361‑2524627; Chandmari PS: 0361‑2660204; Basistha PS: 0361‑2562158; Beltola PS: 0361‑2302158; Noonmati PS: 0361‑2550281",
        "location": "Guwahati, Kamrup Metropolitan, Assam",
        "latitude": 26.1844,
        "longitude": 91.7458
      },
      {
        "name": "Cachar (Silchar)",
        "control": "(03842) 245866 (District PCR)",
        "station": "Silchar PS: 03842‑246279 / 246214; Borkhola PS: 03842‑286433; Katigorah PS: 03842‑268175; Dholai PS: 03842‑258422",
        "location": "Silchar, Cachar, Assam",
        "latitude": 24.8333,
        "longitude": 92.7793
      },
      {
        "name": "Tinsukia District",
        "control": "(0374) 2331476 (Police Control Room)",
        "station": "Tinsukia PS: 0374‑2332100; Bordubi PS: 0374‑2824452; Makum PS: 0374‑2345557; Doomdooma PS: 03759‑240647; Digboi PS: 03751‑264844; Margherita PS: 03751‑220229",
        "location": "Tinsukia, Assam",
        "latitude": 27.4925,
        "longitude": 95.3520
      },
      {
        "name": "Jorhat District",
        "control": "(0376) 2320018 (Police Control Room)",
        "station": "Jorhat PS: 0376‑2320063 / 2320022; Borhula PS: 03771‑247406; Garamur PS: 0376‑274436; Jengraimukh PS: 0376‑272061; Mariani PS: 03771‑2142002; Teok PS: 0376‑2396424; Titabor PS: 03771‑248436",
        "location": "Jorhat, Assam",
        "latitude": 26.7440,
        "longitude": 94.2047
      },
      {
        "name": "Nagaon District",
        "control": "(03672) 235620 (Police Control Room)",
        "station": "SP Office: 03672‑235624; Nagaon PS: (via SP CUG); other local PS follow same STD code",
        "location": "Nagaon, Assam",
        "latitude": 26.3480,
        "longitude": 92.6875
      },
      {
        "name": "Sonitpur District (Tezpur)",
        "control": "6026901052 (Police Control Room)",
        "station": "Tezpur PS: 6026901027; Dhekiajuli PS: 6026901036; Rangapara PS: 6026901031; Missamari PS: 6026901035; Thelamara PS: 6026901037; Bebejia PS: 6026901041",
        "location": "Tezpur, Sonitpur, Assam",
        "latitude": 26.6330,
        "longitude": 92.8032
      },
      {
        "name": "Dibrugarh District",
        "control": "(0373) 2329655 (Police Control Room)",
        "station": "Dibrugarh PS: 0373‑2329067; Moran PS; Naharkatia PS; Chabua PS; Duliajan PS; Lahowal PS",
        "location": "Dibrugarh, Assam",
        "latitude": 27.4833,
        "longitude": 94.9000
      },
      {
        "name": "Dima Hasao District (Haflong)",
        "control": "8638389873 (Police Control Room)",
        "station": "SP Office: 03673‑236325; SDPO Maibang: 03673‑282453; Police Stations: Dehangi, Diyungmukh, Haflong, Harangajao, Langting, Mahur, Maibang, Umrangso",
        "location": "Haflong, Dima Hasao, Assam",
        "latitude": 25.5395,
        "longitude": 93.0982
      },
      {
        "name": "Dhemaji District",
        "control": "6026900356 (PCR Dhemaji)",
        "station": "SP Office: 03753‑224396; SDPO Jonai: 6026900342; Dhemaji PS (Sadar): 6026900345; Silapathar PS: 6026900346; Jonai PS: 6026900347",
        "location": "Dhemaji, Assam",
        "latitude": 27.4833,
        "longitude": 94.5833
      },
      {
        "name": "Karbi Anglong District (Diphu)",
        "control": "(03671) 272254 (Diphu PCR)",
        "station": "Police Stations: Bokajan, Howraghat, Dokmoka, Samelangso, Deithor, plus outposts across district",
        "location": "Diphu, Karbi Anglong, Assam",
        "latitude": 25.8333,
        "longitude": 93.3000
      },
      {
        "name": "Hailakandi District",
        "control": "(03844) 222242 (PCR Hailakandi)",
        "station": "Police Stations: Lala, Katlichera, Algapur, Ramnathpur, Panchgram, Katakhal, Bandukmara, Kalacherra, Bilaipur, Jamira, Karichera, Abdulapur, Lakhi Nagar, Shripur, Mhoanpur",
        "location": "Hailakandi, Assam",
        "latitude": 24.7000,
        "longitude": 92.5500
      },
      {
        "name": "Morigaon District",
        "control": "(03678) 241161 (PCR Morigaon)",
        "station": "Morigaon PS (OC): 03678‑240237; CI Laharighat: 03678‑240052; OC Jagiroad: 03678‑242237",
        "location": "Morigaon, Assam",
        "latitude": 26.3333,
        "longitude": 92.2500
      },
      {
        "name": "Lakhimpur District (North Lakhimpur)",
        "control": "(03752) 223737 (Police Control Room)",
        "station": "North Lakhimpur PS: 03752‑222115; Dhakuakhana PS: 03752‑254525; Bihpuria PS: 03752‑263230; Laluk PS: 03752‑256223; Baginadi PS: 03752‑266366; Ghilamara PS: 03752‑253401",
        "location": "North Lakhimpur, Lakhimpur, Assam",
        "latitude": 27.2300,
        "longitude": 94.1000
      },
      {
        "name": "Barpeta District",
        "control": "(03664) 233xxx (approx. Barpeta PCR)",
        "station": "Barpeta SP Office: 9435049599; Additional PS contacts per district local listings (e.g. Barpeta Town PS)",
        "location": "Barpeta, Assam",
        "latitude": 26.3190,
        "longitude": 90.9640
      },
      {
        "name": "Goalpara District",
        "control": "(03663) 240003 (Goalpara PCR/OC)",
        "station": "Goalpara PS (OC): 03663‑240031; Lakhipur PS: 03663‑283432; Dudhnoi PS: 03663‑281542; Rangjuli PS: 03663‑286042; Dhupdhara PS: 03663‑284303; Matia PS: 03663‑288001; Marnoi PS: 03663‑287001",
        "location": "Goalpara, Assam",
        "latitude": 26.1800,
        "longitude": 90.6330
      }
    ];

    function showAlertStatusMessage(message, isError = false) {
      userMessageText.innerText = message;
      userMessageBox.classList.remove('hidden', 'opacity-0');
      userMessageBox.classList.add('block', 'opacity-100');
      if (isError) {
        userMessageBox.classList.remove('bg-gray-800');
        userMessageBox.classList.add('bg-red-600');
      } else {
        userMessageBox.classList.remove('bg-red-600');
        userMessageBox.classList.add('bg-gray-800');
      }

      setTimeout(() => {
        userMessageBox.classList.remove('opacity-100');
        userMessageBox.classList.add('opacity-0');
        userMessageBox.addEventListener('transitionend', function handler() {
          userMessageBox.classList.add('hidden');
          userMessageBox.removeEventListener('transitionend', handler);
        }, { once: true });
      }, 3000);
    }

    function fetchUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            latestLocation = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            };
            console.log("📍 Location fetched at login:", latestLocation);
          },
          (error) => {
            console.warn("⚠️ Could not fetch location at login:", error.message);
            latestLocation = { latitude: 0, longitude: 0, locationUnavailable: true };
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }
    }

    function loginUser() {
      const mobile = document.getElementById("mobile").value;
      const userName = userNameInput.value.trim();

      if (!userName) {
        showAlertStatusMessage("Please enter your name.", true);
        return;
      }

      if (/^\d{10}$/.test(mobile)) {
        localStorage.setItem("mobile", mobile);
        localStorage.setItem("userName", userName);
        document.getElementById("userMobile").innerText = `${userName} (${mobile})`;

        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        fetchUserLocation();

        set(ref(db, `users/${mobile}`), {
          mobile: mobile,
          name: userName,
          registeredAt: new Date().toISOString()
        }).then(() => {
          displayPreviousAlerts(mobile);
          fetchAndDisplayBanner();
          displayChatMessages(mobile);
        }).catch((error) => {
          console.error("Firebase registration error:", error);
          showAlertStatusMessage("Failed to register user: " + error.message, true);
        });
      } else {
        showAlertStatusMessage("Please enter a valid 10-digit mobile number.", true);
      }
    }

    function logoutUser() {
      localStorage.removeItem("mobile");
      localStorage.removeItem("userName");
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("loginSection").classList.remove("hidden");
      document.getElementById("mobile").value = '';
      document.getElementById("userName").value = '';
      showAlertStatusMessage("You have been logged out.", false);
      clearInterval(countdownInterval);
      countdownDisplay.classList.add('hidden');
      enableAlertButtons();
    }

    function toggleCustomMessageInput() {
      document.getElementById("customMessageInput").classList.toggle("hidden");
      if (!document.getElementById("customMessageInput").classList.contains('hidden')) {
        document.getElementById("customMessage").focus();
      }
    }

    function toRadians(degrees) {
      return degrees * Math.PI / 180;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = toRadians(lat2 - lat1);
      const dLon = toRadians(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function findNearestPoliceStation(userLat, userLon) {
      if (!policeStationsData || policeStationsData.length === 0) {
        console.warn("No police station data loaded for nearest calculation.");
        return null;
      }

      let nearestStation = null;
      let minDistance = Infinity;

      policeStationsData.forEach(station => {
        if (typeof station.latitude === 'number' && typeof station.longitude === 'number') {
          const distance = haversineDistance(userLat, userLon, station.latitude, station.longitude);
          if (distance < minDistance) {
            minDistance = distance;
            nearestStation = station;
          }
        } else {
          console.warn(`Police station "${station.name}" missing valid latitude/longitude for distance calculation.`);
        }
      });
      return nearestStation;
    }

    function disableAlertButtons() {
      document.getElementById("dangerAlertBtn").disabled = true;
      document.getElementById("callAlertBtn").disabled = true;
      document.getElementById("customAlertToggleBtn").disabled = true;
      document.getElementById("sendCustomAlertBtn").disabled = true;
    }

    function enableAlertButtons() {
      document.getElementById("dangerAlertBtn").disabled = false;
      document.getElementById("callAlertBtn").disabled = false;
      document.getElementById("customAlertToggleBtn").disabled = false;
      document.getElementById("sendCustomAlertBtn").disabled = false;
    }

    function initiateAlert(type) {
      currentAlertType = type;
      let countdown = 5;
      countdownDisplay.innerText = `Sending alert in ${countdown} seconds...`;
      countdownDisplay.classList.remove('hidden');
      disableAlertButtons();

      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      countdownInterval = setInterval(() => {
        countdown--;
        countdownDisplay.innerText = `Sending alert in ${countdown} seconds...`;
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          countdownDisplay.classList.add('hidden');
          enableAlertButtons();
          sendAlert(currentAlertType);
          currentAlertType = null;
        }
      }, 1000);
    }

    function sendAlert(type) {
      const mobile = localStorage.getItem("mobile");
      if (!mobile) {
        showAlertStatusMessage("User not logged in. Please register first.", true);
        return;
      }

      const timestampRaw = new Date().toISOString();
      const timestamp = timestampRaw.replace(/[.#$\[\]]/g, '_');

      let message = "";
      if (type === 'custom') {
        message = document.getElementById("customMessage").value.trim();
        if (!message) {
          showAlertStatusMessage("Please enter a custom message.", true);
          return;
        }
      }

      let batteryLevel = 'N/A';
      let isCharging = 'N/A';

      const getBatteryInfo = () => {
          return new Promise(resolve => {
              if ('getBattery' in navigator) {
                  navigator.getBattery().then(battery => {
                      batteryLevel = (battery.level * 100).toFixed(0) + '%';
                      isCharging = battery.charging ? 'Yes' : 'No';
                      resolve();
                  }).catch(e => {
                      console.warn("Could not get battery info:", e);
                      resolve(); // Resolve anyway to not block alert sending
                  });
              } else {
                  resolve();
              }
          });
      };

      const getDeviceType = () => {
          const ua = navigator.userAgent;
          if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua) ||
              /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua)) {
              return "Mobile";
          }
          return "Desktop";
      };

      const getNetworkType = () => {
        if (navigator.connection && navigator.connection.effectiveType) {
            return navigator.connection.effectiveType; // e.g., "4g", "3g", "2g", "slow-2g"
        } else if (navigator.connection && navigator.connection.type) {
            return navigator.connection.type; // e.g., "wifi", "cellular", "ethernet", "none"
        }
        return 'Unknown';
      };


      const deviceType = getDeviceType();
      const networkType = getNetworkType();


      getBatteryInfo().then(() => {
          const saveAlert = (location, locationAvailable) => {
              let adminReplyMessage = "";
              let autoStatus = "pending";

              if (type === 'danger' && locationAvailable && location.latitude !== 0 && location.longitude !== 0) {
                  const nearestStation = findNearestPoliceStation(location.latitude, location.longitude);
                  if (nearestStation) {
                      adminReplyMessage = `Emergency. Your nearest PS is ${nearestStation.name}. Control: ${nearestStation.control}, Station: ${nearestStation.station}.`;
                      autoStatus = "responded";
                  } else {
                      getPoliceControlNumber().then(generalNum => {
                          if (generalNum) {
                              adminReplyMessage = `Emergency. Please contact Police Control: ${generalNum}.`;
                              autoStatus = "responded";
                          } else {
                              getAutoReply('danger').then(defaultDangerReply => {
                                  adminReplyMessage = defaultDangerReply || "Emergency alert received. Help is on the way.";
                                  autoStatus = defaultDangerReply ? "responded" : "pending";
                              }).finally(() => {
                                  finalizeAndSendAlert(mobile, timestamp, type, location, message, adminReplyMessage, autoStatus);
                              });
                          }
                      }).catch(error => {
                          console.error("Error fetching general police control number:", error);
                          getAutoReply('danger').then(defaultDangerReply => {
                              adminReplyMessage = defaultDangerReply || "Emergency alert received. Help is on the way.";
                              autoStatus = defaultDangerReply ? "responded" : "pending";
                          }).finally(() => {
                              finalizeAndSendAlert(mobile, timestamp, type, location, message, adminReplyMessage, autoStatus);
                          });
                      });
                      return;
                  }
              } else {
                  getAutoReply(type).then(autoReplyText => {
                      adminReplyMessage = autoReplyText || "";
                      autoStatus = autoReplyText ? "responded" : "pending";
                  }).finally(() => {
                      finalizeAndSendAlert(mobile, timestamp, type, location, message, adminReplyMessage, autoStatus);
                  });
                  return;
              }

              finalizeAndSendAlert(mobile, timestamp, type, location, message, adminReplyMessage, autoStatus);
          };

          const finalizeAndSendAlert = (mobile, timestamp, type, location, message, adminReply, status) => {
              const alertData = {
                  type: type,
                  location: location,
                  time: timestampRaw,
                  message: message,
                  status: status,
                  adminReply: adminReply,
                  battery: {
                      level: batteryLevel,
                      isCharging: isCharging
                  },
                  deviceType: deviceType,
                  networkType: networkType // Added network type here
              };

              const userAlertPath = `users/${mobile}/alerts/${timestamp}`;
              const allAlertsPath = `all_emergency_alerts/${mobile}_${timestamp}`;

              set(ref(db, userAlertPath), alertData)
                  .then(() => {
                      const globalAlertData = {
                          ...alertData,
                          userId: mobile,
                          userAlertId: timestamp
                      };
                      return set(ref(db, allAlertsPath), globalAlertData);
                  })
                  .then(() => {
                      let statusMessage = "✅ Alert sent successfully!";
                      let isErrorMessage = false;
                      if (location.latitude === 0 && location.longitude === 0 && location.locationUnavailable) {
                          statusMessage += " Location could not be accurately determined.";
                          isErrorMessage = true;
                      } else if (location.latitude !== 0 || location.longitude !== 0) {
                          statusMessage += " Your location was captured.";
                      }

                      showAlertStatusMessage(statusMessage, isErrorMessage);
                      document.getElementById("customMessage").value = '';
                      document.getElementById("customMessageInput").classList.add("hidden");
                      displayPreviousAlerts(mobile);
                  })
                  .catch((error) => {
                      console.error("Firebase error:", error);
                      showAlertStatusMessage("❌ Failed to send alert: " + error.message, true);
                  });
          };

          if (latestLocation && (latestLocation.latitude !== 0 || latestLocation.longitude !== 0)) {
              saveAlert(latestLocation, true);
          } else {
              if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(
                      (position) => {
                          const location = {
                              latitude: position.coords.latitude,
                              longitude: position.coords.longitude
                          };
                          saveAlert(location, true);
                      },
                      (error) => {
                          const fallback = {
                              latitude: 0,
                              longitude: 0,
                              locationUnavailable: true
                          };
                          saveAlert(fallback, false);
                      }, {
                          enableHighAccuracy: true,
                          timeout: 10000,
                          maximumAge: 0
                      }
                  );
              } else {
                  const fallback = {
                      latitude: 0,
                      longitude: 0,
                      locationUnavailable: true
                  };
                  saveAlert(fallback, false);
              }
          }
      });
    }

    function getAutoReply(type) {
      return new Promise((resolve, reject) => {
        onValue(ref(db, `admin/autoReplies/${type}`), (snapshot) => {
          const autoReplyMessage = snapshot.val();
          resolve(autoReplyMessage || '');
        }, {
          onlyOnce: true
        }, (error) => {
          reject(error);
        });
      });
    }

    function getPoliceControlNumber() {
      return new Promise((resolve, reject) => {
        onValue(ref(db, 'admin/autoReplies/policeControlNumber'), (snapshot) => {
          const policeNum = snapshot.val();
          resolve(policeNum || '');
        }, {
          onlyOnce: true
        }, (error) => {
          reject(error);
        });
      });
    }

    function displayPreviousAlerts(mobile) {
      const previousAlertsDiv = document.getElementById("previousAlerts");
      previousAlertsDiv.innerHTML = '<p class="text-gray-500 text-center py-3">Loading previous alerts...</p>';

      const alertsRef = query(ref(db, `users/${mobile}/alerts`), orderByChild('time'), limitToLast(10));

      onValue(alertsRef, (snapshot) => {
        if (snapshot.exists()) {
          const alerts = [];
          snapshot.forEach((childSnapshot) => {
            alerts.push(childSnapshot.val());
          });
          alerts.reverse();

          previousAlertsDiv.innerHTML = '';
          alerts.forEach(alert => {
            const alertElement = document.createElement('div');
            alertElement.className = 'border-b last:border-b-0 py-2 alert-card text-xs sm:text-sm';

            const date = new Date(alert.time);
            const formattedDate = date.toLocaleString();

            let locationInfo = '';
            if (alert.location && alert.location.latitude !== 0 && alert.location.longitude !== 0 && !alert.location.locationUnavailable) {
              const lat = alert.location.latitude.toFixed(4);
              const lon = alert.location.longitude.toFixed(4);
              const mapLink = `http://maps.google.com/?q=${lat},${lon}`;
              locationInfo = `Lat: ${lat}, Lon: ${lon} - <a href="${mapLink}" target="_blank" class="text-blue-600 underline hover:text-blue-800">View on Map</a>`;
            } else {
              locationInfo = 'Location not precisely captured.';
            }

            let messageContent = alert.message ? `<p class="text-xs sm:text-sm">Message: <span class="font-normal">${alert.message}</span></p>` : '';
            let adminReplyContent = alert.adminReply ? `<p class="text-xs sm:text-sm text-blue-700">Admin Reply: <span class="font-normal">${alert.adminReply}</span></p>` : '';

            let statusClass = 'bg-gray-200';
            if (alert.status === 'responded') statusClass = 'bg-green-200 text-green-800';
            else if (alert.status === 'under review') statusClass = 'bg-yellow-200 text-yellow-800';
            else if (alert.status === 'pending') statusClass = 'bg-red-200 text-red-800';

            const statusBadge = `<span class="text-2xs sm:text-xs px-2 py-1 rounded-full ${statusClass}">${alert.status || 'pending'}</span>`;

            alertElement.innerHTML = `
              <div class="flex justify-between items-start">
                <p class="font-semibold capitalize">${alert.type} Alert</p>
                ${statusBadge}
              </div>
              <p class="text-xs sm:text-sm">Time: <span class="font-normal">${formattedDate}</span></p>
              <p class="text-xs sm:text-sm">Location: <span class="font-normal">${locationInfo}</span></p>
              ${messageContent}
              ${adminReplyContent}
            `;
            previousAlertsDiv.appendChild(alertElement);
          });
        } else {
          previousAlertsDiv.innerHTML = '<p class="text-gray-500 text-center py-3">No previous alerts.</p>';
        }
      }, (error) => {
        console.error("Error fetching previous alerts:", error);
        previousAlertsDiv.innerHTML = '<p class="text-red-500 text-center">Error loading alerts.</p>';
      });
    }

    function fetchAndDisplayBanner() {
      const bannerRef = ref(db, 'admin/bannerMessage');
      onValue(bannerRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.message) {
          bannerMessageElement.innerText = data.message;
          adminBannerElement.classList.remove('hidden');
        } else {
          adminBannerElement.classList.add('hidden');
        }
      });
    }

    function sendChatMessage() {
      const mobile = localStorage.getItem("mobile");
      const userName = localStorage.getItem("userName");
      const chatMessageInput = document.getElementById("chatMessageInput");
      const messageText = chatMessageInput.value.trim();

      if (!mobile || !userName) {
        showAlertStatusMessage("Please login to send messages.", true);
        return;
      }
      if (!messageText) {
        return;
      }

      const chatRef = ref(db, `chats/${mobile}`);
      push(chatRef, {
        sender: userName,
        message: messageText,
        time: new Date().toISOString()
      }).then(() => {
        chatMessageInput.value = '';
      }).catch((error) => {
        console.error("Error sending chat message:", error);
        showAlertStatusMessage("Failed to send message: " + error.message, true);
      });
    }

    function displayChatMessages(mobile) {
      const chatMessagesDiv = document.getElementById("chatMessages");
      chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-3">Loading chat...</p>';

      const chatRef = query(ref(db, `chats/${mobile}`), orderByChild('time'), limitToLast(50));

      onValue(chatRef, (snapshot) => {
        chatMessagesDiv.innerHTML = '';
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const message = childSnapshot.val();
            const messageElement = document.createElement('div');
            const date = new Date(message.time);
            const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageElement.className = `mb-2 p-2 rounded-lg ${message.sender === localStorage.getItem("userName") ? 'bg-blue-100 ml-auto text-right' : 'bg-gray-200 mr-auto text-left'}`;
            messageElement.style.maxWidth = '80%';

            messageElement.innerHTML = `
              <p class="font-semibold text-xs sm:text-sm">${message.sender}</p>
              <p class="text-gray-800">${message.message}</p>
              <p class="text-2xs sm:text-xs text-gray-500 mt-1">${formattedTime}</p>
            `;
            chatMessagesDiv.appendChild(messageElement);
          });
          chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        } else {
          chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center py-3">No messages yet.</p>';
        }
      }, (error) => {
        console.error("Error fetching chat messages:", error);
        chatMessagesDiv.innerHTML = '<p class="text-red-500 text-center">Error loading chat.</p>';
      });
    }

    window.loginUser = loginUser;
    window.initiateAlert = initiateAlert;
    window.toggleCustomMessageInput = toggleCustomMessageInput;
    window.logoutUser = logoutUser;
    window.sendChatMessage = sendChatMessage;

    window.addEventListener("load", () => {
      const savedMobile = localStorage.getItem("mobile");
      const savedUserName = localStorage.getItem("userName"); 

      if (savedMobile) {
        if (savedUserName) {
          document.getElementById("userMobile").innerText = `${savedUserName} (${savedMobile})`; 
        } else {
          document.getElementById("userMobile").innerText = savedMobile;
        }
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        fetchUserLocation();
        displayPreviousAlerts(savedMobile);
        fetchAndDisplayBanner();
        displayChatMessages(savedMobile);
      }
    });
  </script>
</body>
</html>
