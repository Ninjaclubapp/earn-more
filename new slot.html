<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Slots India - VIP Access</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --gold: #ffd700;
            --neon-blue: #00f2ff;
            --neon-pink: #ff007f;
            --bg: #0a0a0f;
            --panel: #161625;
            --success: #2ed573;
            --danger: #ff4757;
            --warning: #ffa502;
            --modal-bg: rgba(0, 0, 0, 0.95);
            --free-spin: #9b59b6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- REDESIGNED GREEDY LOGIN STYLES --- */
        #auth-screen {
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            background-image: 
                linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffd700' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }

        .greedy-card {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border: 2px solid var(--gold);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .greedy-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
            pointer-events: none; 
            z-index: 1;
        }

        @keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }

        .greedy-card > * { position: relative; z-index: 2; }

        .jackpot-banner { text-align: center; margin-bottom: 20px; }
        .jackpot-label { color: var(--neon-pink); font-size: 0.8rem; letter-spacing: 2px; font-weight: bold; text-transform: uppercase; }
        .jackpot-amount {
            font-size: 2.5rem; font-weight: 900;
            background: linear-gradient(to bottom, #ffd700, #ffed4e, #b8860b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4); font-family: 'Courier New', monospace;
        }

        .bonus-badge {
            background: linear-gradient(90deg, #ff007f, #ff4757);
            color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 0.9rem;
            margin: -25px -25px 20px -25px; box-shadow: 0 5px 15px rgba(255, 0, 127, 0.4);
            animation: pulse-badge 1.5s infinite; z-index: 5 !important;
            white-space: pre-wrap;
        }
        @keyframes pulse-badge { 0% { opacity: 0.9; } 50% { opacity: 1; text-shadow: 0 0 10px white; } 100% { opacity: 0.9; } }

        .auth-input {
            background: rgba(0, 0, 0, 0.6) !important; border: 1px solid #444 !important; transition: 0.3s;
            color: var(--gold) !important; font-weight: bold; position: relative; z-index: 10;
        }
        .auth-input:focus { border-color: var(--gold) !important; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }

        .btn-greedy {
            background: linear-gradient(to bottom, #ffd700, #b8860b); color: black; font-weight: 900;
            text-transform: uppercase; font-size: 1.1rem; padding: 15px; border: none; border-radius: 8px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); animation: bounce-btn 2s infinite;
            width: 100%; margin-top: 15px; position: relative; z-index: 10;
        }
        @keyframes bounce-btn {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);}
        }

        .trust-row { display: flex; justify-content: center; gap: 15px; margin-top: 20px; opacity: 0.7; }
        .trust-icon { font-size: 1.5rem; }

        .live-users {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 242, 255, 0.1); border: 1px solid var(--neon-blue);
            padding: 5px 15px; border-radius: 20px; color: var(--neon-blue); font-size: 0.8rem;
            display: flex; align-items: center; gap: 8px; z-index: 2001;
        }
        .online-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }

        /* --- END LOGIN STYLES --- */

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        
        .modal-suspension {
             z-index: 9999; background: black; text-align: center;
        }

        .auth-card {
            background: var(--panel); padding: 25px; border-radius: 15px;
            width: 100%; max-width: 400px; border: 1px solid #333;
            box-shadow: 0 0 30px rgba(0,242,255,0.1); max-height: 90vh; overflow-y: auto;
        }

        .auth-input, .complaint-area {
            width: 100%; padding: 12px; margin: 8px 0;
            background: #000; border: 1px solid #444; color: white; border-radius: 8px; font-size: 0.9rem;
        }

        .security-section {
            margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.05);
            border-radius: 8px; border: 1px dashed var(--gold);
        }

        .warning-note {
            background: rgba(255, 71, 87, 0.1); border-left: 3px solid var(--danger);
            padding: 10px; font-size: 0.75rem; color: #ff9f9f; margin-bottom: 15px; line-height: 1.4;
        }

        .complaint-area { height: 80px; resize: none; font-family: inherit; }

        .amt-presets { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 10px 0; }
        .preset-btn { background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }

        .pay-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }

        .pay-btn {
            padding: 12px 5px; font-size: 0.75rem; border-radius: 5px; border: none;
            cursor: pointer; font-weight: bold; color: white; text-align: center;
        }

        .btn-super { background: #6c5ce7; }
        .btn-upi { background: #00b894; }
        .btn-paytm { background: #0984e3; }
        .btn-withdraw { background: var(--danger); width: 100%; margin-top: 10px; }

        .status-popup {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 15px 25px; border-radius: 10px; font-weight: bold;
            z-index: 3000; animation: slideDown 0.3s ease-out;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; min-width: 280px;
        }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
        
        .free-spins-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 30px 40px; border-radius: 15px; font-weight: bold;
            z-index: 4000; animation: pulse 1.5s infinite;
            box-shadow: 0 10px 40px rgba(155, 89, 182, 0.7); text-align: center;
            background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; font-size: 1.5rem; min-width: 300px;
        }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } 100% { transform: translate(-50%, -50%) scale(1); } }

        .announcement-bar {
            width: 100%; background: rgba(255, 0, 127, 0.1); color: white;
            padding: 8px 0; font-size: 0.85rem; margin-bottom: 15px;
            overflow: hidden; white-space: nowrap; border-top: 1px solid #333; border-bottom: 1px solid #333;
        }
        .marquee { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .container { width: 100%; max-width: 500px; padding: 15px; }

        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-badge { display: flex; align-items: center; gap: 8px; }

        .bank-header {
            background: var(--panel); padding: 20px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 3px solid var(--neon-blue); margin-bottom: 20px;
        }

        .bal-val { font-size: 1.5rem; font-weight: bold; color: var(--gold); }
        
        .slot-machine {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            background: #000; padding: 12px; border-radius: 15px; border: 4px solid #333; margin-bottom: 20px;
        }

        .reel { display: flex; flex-direction: column; gap: 10px; }
        .cell {
            aspect-ratio: 1/1; background: #1e1e35; display: flex;
            align-items: center; justify-content: center; font-size: 2.5rem; border-radius: 10px;
        }
        .spinning { animation: fastSlide 0.1s infinite linear; }
        @keyframes fastSlide { 0% { transform: translateY(-5px); filter: blur(3px); } 100% { transform: translateY(5px); filter: blur(3px); } }
        
        .winner-cell { background: var(--gold) !important; box-shadow: 0 0 25px var(--gold); transform: scale(1.05); z-index: 2; }
        .scatter-cell { background: var(--free-spin) !important; box-shadow: 0 0 25px var(--free-spin); transform: scale(1.05); z-index: 2; animation: scatterGlow 1s infinite alternate; }
        @keyframes scatterGlow { from { box-shadow: 0 0 15px var(--free-spin); } to { box-shadow: 0 0 30px var(--free-spin); } }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .bet-container { grid-column: span 2; background: var(--panel); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }

        .btn { padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-spin { background: var(--neon-blue); color: #000; }
        .btn-auto { background: #333; color: white; }
        .btn-auto.active { background: var(--danger); }
        .btn-free { background: var(--free-spin); color: white; }

        .history-box { background: var(--panel); border-radius: 12px; padding: 15px; margin-top: 10px;}
        .history-list { height: 250px; overflow-y: auto; margin-top: 10px; font-size: 0.85rem; }
        .history-item { display: flex; flex-direction: column; padding: 12px 0; border-bottom: 1px solid #222; gap: 5px;}
        
        .status-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .tag-pending { background: var(--warning); color: black; }
        .tag-processing { background: var(--neon-blue); color: black; }
        .tag-approved { background: var(--success); color: black; }
        .tag-rejected { background: var(--danger); color: white; }
        .tag-freespin { background: var(--free-spin); color: white; }

        .complaint-btn { font-size: 0.65rem; background: #333; color: var(--neon-blue); border: 1px solid var(--neon-blue); padding: 2px 8px; border-radius: 4px; cursor: pointer; width: fit-content; margin-top: 5px; }

        #msg { 
            height: 35px; color: var(--neon-blue); margin-bottom: 10px; font-weight: bold; 
            text-align: center; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; padding: 5px;
        }
        
        .win-message {
            background: linear-gradient(45deg, var(--gold), #ffed4e); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); animation: winPulse 0.5s infinite alternate;
        }
        @keyframes winPulse { from { transform: scale(1); } to { transform: scale(1.05); } }
        
        .hidden { display: none !important; }
        
        /* Firebase connection status */
        .connection-status {
            position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; border-radius: 15px; font-size: 0.7rem; z-index: 1000;
        }
        .connection-online { background: var(--success); color: black; }
        .connection-offline { background: var(--danger); color: white; }
        
        .free-spins-counter {
            position: absolute; top: 10px; right: 10px; background: var(--free-spin);
            color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }
        
        .win-amount {
            font-weight: bold; background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            padding: 2px 5px; border-radius: 4px;
        }
        
        .free-spin-text {
            font-weight: bold; background: linear-gradient(45deg, #9b59b6, #8e44ad);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        
        .jackpot-text {
            font-size: 1.5rem; color: #ff007f; animation: pulse 0.5s infinite; text-shadow: 0 0 10px #ff007f;
        }
        
        .big-win-text {
            font-size: 1.3rem; color: #ffd700; animation: bounce-btn 1s infinite; text-shadow: 0 0 10px #ffd700;
        }

        .mini-history {
            max-height: 150px; overflow-y: auto; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 5px;
        }
        .mini-item {
            font-size: 0.75rem; border-bottom: 1px solid #333; padding: 5px 0; color: #aaa;
        }

        /* --- BONUS & REFERRAL STYLES --- */
        .bonus-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            margin-bottom: 20px;
        }
        .day-card {
            background: #222; border: 1px solid #444; border-radius: 8px;
            padding: 10px 5px; text-align: center; position: relative; opacity: 0.7;
        }
        .day-card.active { border-color: var(--neon-blue); opacity: 1; box-shadow: 0 0 10px rgba(0,242,255,0.3); }
        .day-card.claimed { border-color: var(--success); opacity: 0.5; }
        .day-num { font-size: 0.7rem; color: #aaa; margin-bottom: 5px; }
        .day-rew { color: var(--gold); font-weight: bold; font-size: 0.9rem; }
        .day-icon { font-size: 1.2rem; margin-bottom: 5px; }
        .claimed-badge { 
            position: absolute; top: -5px; right: -5px; background: var(--success);
            color: black; font-size: 0.6rem; padding: 2px 4px; border-radius: 50%;
        }
        .bonus-btn-main {
            background: linear-gradient(45deg, #ffd700, #ff9f00); color: black;
            border: none; padding: 12px; width: 100%; border-radius: 8px;
            font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .bonus-btn-main:disabled { background: #444; color: #888; cursor: not-allowed; }

        .refer-code-display {
            background: #111; border: 2px dashed var(--neon-blue); padding: 15px;
            text-align: center; font-family: monospace; font-size: 1.5rem; letter-spacing: 2px;
            color: var(--neon-blue); margin: 20px 0; border-radius: 8px; cursor: pointer;
        }
        .whatsapp-btn {
            background: #25D366; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px;
            font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; font-size: 0.9rem;
        }
        
        /* New Balance Display Styles */
        .balance-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .balance-item {
            text-align: center;
            flex: 1;
        }
        .balance-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 5px;
        }
        .balance-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .wallet-balance { color: var(--gold); }
        .withdrawable-balance { color: var(--success); }
        
        /* Withdrawable balance indicator - REMOVED */
        .withdrawable-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--success);
            color: black;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="status-container"></div>
    
    <div id="free-spins-popup" class="free-spins-popup hidden"></div>
    
    <div id="firebase-status" class="connection-status connection-offline">Offline</div>
    
    <div id="free-spins-counter" class="free-spins-counter hidden">
        <span>üéÅ</span> <span id="free-spins-count">0</span> FREE SPINS
    </div>

    <!-- Suspension Modal -->
    <div id="suspend-modal" class="modal modal-suspension hidden">
        <h2 style="color:var(--danger); margin-bottom:20px;">üö´ ACCOUNT SUSPENDED</h2>
        <p id="suspend-msg" style="color:white; margin-bottom:20px;">Your account suspended for fraud activities.</p>
        <p style="color:#888;">Contact: <span style="color:var(--neon-blue);">helloworld@gmail.com</span></p>
    </div>

    <div id="auth-screen">
        <div class="live-users">
            <div class="online-dot"></div> <span id="live-count">24,839</span> Players Online
        </div>
        
        <div class="auth-card greedy-card">
            <div class="bonus-badge" id="greedy-offer-text">üî• Deposit 20 get extra 50 cash üî•</div>
            <div class="jackpot-banner">
                <div class="jackpot-label">PROGRESSIVE JACKPOT</div>
                <div class="jackpot-amount">‚Çπ12,45,980</div>
            </div>

            <h2 id="auth-title" style="color: white; text-align: center; margin-bottom: 15px; font-weight:300;">VIP MEMBER ACCESS</h2>
            <input type="number" id="auth-phone" class="auth-input" placeholder="üì± Enter Mobile Number">
            <input type="password" id="auth-pass" class="auth-input" placeholder="üîí Enter Password">
            
            <!-- Optional Referral Code Field -->
            <input type="text" id="auth-referral" class="auth-input hidden" placeholder="üéüÔ∏è Referral Code (Optional)">
            
            <button class="btn btn-greedy" onclick="handleAuth()">LOGIN & WIN BIG üé∞</button>
            <div style="margin-top: 20px; text-align: center;">
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">Don't have an account?</p>
                <div style="font-size: 0.95rem; color: var(--neon-blue); cursor: pointer; text-decoration: underline; font-weight: bold;" onclick="toggleAuthMode()" id="auth-toggle-text">CLAIM REGISTRATION BONUS NOW</div>
            </div>
            <div class="trust-row">
                <div class="trust-icon">üîí</div><div class="trust-icon">üõ°Ô∏è</div><div class="trust-icon">üè¶</div><div class="trust-icon">‚ö°</div>
            </div>
            <div style="text-align: center; font-size: 0.65rem; color: #666; margin-top: 10px;">SSL SECURE CONNECTION ‚Ä¢ 24/7 PAYOUTS</div>
        </div>
    </div>

    <!-- Updated Withdraw Modal with Two Balances -->
    <div id="withdraw-modal" class="modal hidden">
        <div class="auth-card">
            <h3 style="color: var(--danger); text-align: center; margin-bottom: 10px;">Withdraw Funds</h3>
            
            <!-- Two Balance Display -->
            <div class="balance-display">
                <div class="balance-item">
                    <div class="balance-label">WALLET BALANCE</div>
                    <div class="balance-value wallet-balance">‚Çπ<span id="withdraw-wallet-balance">0</span></div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">WITHDRAWABLE BALANCE</div>
                    <div class="balance-value withdrawable-balance">‚Çπ<span id="withdraw-available-balance">0</span></div>
                </div>
            </div>
            
            <div class="warning-note">
                <strong>NOTE:</strong> Please enter correct and genuine bank account details. Any fake, inactive, or wrong account number may cause automatic deduction.
            </div>
            <label style="font-size: 0.75rem; color: var(--gold);">BANK DETAILS</label>
            <input type="text" id="wit-holder" class="auth-input" placeholder="Account Holder Name">
            <input type="text" id="wit-bank" class="auth-input" placeholder="Bank Name">
            <input type="number" id="wit-acc" class="auth-input" placeholder="Account Number">
            <input type="text" id="wit-ifsc" class="auth-input" placeholder="IFSC Code">
            <hr style="border: 0; border-top: 1px solid #333; margin: 10px 0;">
            <label style="font-size: 0.75rem; color: #888;">Withdraw Amount (Min ‚Çπ110)</label>
            <input type="number" id="wit-amt-input" class="auth-input" value="110">
            <div class="security-section">
                <p style="font-size: 0.7rem; color: var(--gold); margin-bottom: 5px; text-align: center;">VERIFY IDENTITY</p>
                <input type="number" id="wit-sec-phone" class="auth-input" placeholder="Confirm Phone">
                <input type="password" id="wit-sec-pass" class="auth-input" placeholder="Confirm Password">
            </div>
            <button class="pay-btn btn-withdraw" onclick="triggerWithdraw()">PLACE WITHDRAWAL</button>

            <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <h4 style="color: #aaa; font-size: 0.8rem;">Recent Withdrawals</h4>
                <button onclick="openComplaint('withdraw')" style="background:none; border:none; color:var(--warning); font-size:0.7rem; cursor:pointer; text-decoration:underline;">Report Issue</button>
            </div>
            <div id="withdraw-history" class="mini-history"></div>

            <button onclick="closeModals()" style="background:none; border:none; color:#666; width:100%; margin-top:15px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="deposit-modal" class="modal hidden">
        <div class="auth-card">
            <h3 style="color: var(--gold); text-align: center; margin-bottom: 15px;">Add Funds</h3>
            <label style="font-size: 0.8rem; color: #888;">Deposit Amount (‚Çπ)</label>
            <input type="number" id="dep-amt-input" class="auth-input" value="500">
            <div class="amt-presets">
                <button class="preset-btn" onclick="setAmt('dep-amt-input', 500)">+‚Çπ500</button>
                <button class="preset-btn" onclick="setAmt('dep-amt-input', 1000)">+‚Çπ1000</button>
                <button class="preset-btn" onclick="setAmt('dep-amt-input', 2000)">+‚Çπ2000</button>
            </div>
            <div class="security-section">
                <p style="font-size: 0.7rem; color: var(--gold); margin-bottom: 5px; text-align: center;">VERIFY IDENTITY</p>
                <input type="number" id="dep-sec-phone" class="auth-input" placeholder="Confirm Phone">
                <input type="password" id="dep-sec-pass" class="auth-input" placeholder="Confirm Password">
            </div>
            <div class="pay-row">
                <button class="pay-btn btn-super" onclick="triggerPayment('Superpay')">Superpay</button>
                <button class="pay-btn btn-upi" onclick="triggerPayment('UPI')">UPI</button>
                <button class="pay-btn btn-paytm" onclick="triggerPayment('Paytm')">Paytm</button>
            </div>
            
            <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <h4 style="color: #aaa; font-size: 0.8rem;">Recent Deposits</h4>
                <button onclick="openComplaint('deposit')" style="background:none; border:none; color:var(--warning); font-size:0.7rem; cursor:pointer; text-decoration:underline;">Report Issue</button>
            </div>
            <div id="deposit-history" class="mini-history"></div>

            <button onclick="closeModals()" style="background:none; border:none; color:#666; width:100%; margin-top:15px; cursor:pointer;">Go Back</button>
        </div>
    </div>

    <!-- Other modals remain the same -->
    <div id="complaint-modal" class="modal hidden">
        <div class="auth-card">
            <h3 style="color: var(--neon-blue); text-align: center; margin-bottom: 10px;">File a Complaint</h3>
            <p id="complaint-type-label" style="font-size: 0.8rem; color: #888; margin-bottom: 10px;"></p>
            <div id="utr-container">
                <input type="text" id="complaint-ref" class="auth-input" placeholder="UTR / Reference Number">
            </div>
            <textarea id="complaint-text" class="complaint-area" placeholder="Describe your issue here..."></textarea>
            <button class="btn btn-spin" style="width: 100%;" onclick="submitComplaint()">Submit Ticket</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#666; width:100%; margin-top:15px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="bonus-modal" class="modal hidden">
        <div class="auth-card">
            <h3 style="color: var(--gold); text-align: center; margin-bottom: 5px;">Daily Rewards</h3>
            <p style="color:#888; text-align:center; font-size:0.8rem; margin-bottom:20px;">Login every day to collect free cash!</p>
            
            <div class="bonus-grid" id="bonus-grid-container">
                <!-- Populated by JS -->
            </div>
            
            <button id="claim-bonus-btn" class="bonus-btn-main" onclick="claimDailyBonus()">CLAIM BONUS</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#666; width:100%; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="refer-modal" class="modal hidden">
        <div class="auth-card">
            <h3 style="color: var(--success); text-align: center; margin-bottom: 5px;">Refer & Earn</h3>
            <p style="color:#aaa; text-align:center; font-size:0.8rem; margin-bottom:20px;">Share your code. Both you and your friend get ‚Çπ25!</p>
            
            <div style="text-align:center;">
                <label style="color:#888; font-size:0.7rem;">YOUR UNIQUE CODE</label>
                <div class="refer-code-display" id="my-referral-code" onclick="copyReferral()">LOADING...</div>
                <div style="color:var(--success); font-size:0.7rem; min-height:15px;" id="copy-msg">Tap code to copy</div>
            </div>
            
            <div style="background:#222; padding:10px; border-radius:8px; margin-top:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="color:#aaa;">Referral Bonus</span>
                    <span style="color:var(--gold);">‚Çπ25</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:#aaa;">Friend Gets</span>
                    <span style="color:var(--gold);">‚Çπ25</span>
                </div>
            </div>

            <button class="whatsapp-btn" onclick="shareToWhatsapp()">Share on WhatsApp</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#666; width:100%; margin-top:15px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="support-modal" class="modal hidden">
        <div class="auth-card" style="height: 80vh; display: flex; flex-direction: column;">
            <h3 style="color: var(--success); text-align: center; margin-bottom: 10px;">üéß Live Support</h3>
            <div id="support-chat-area" style="flex:1; background:#111; border:1px solid #333; border-radius:8px; padding:10px; overflow-y:auto; margin-bottom:10px; display:flex; flex-direction:column; gap:10px;">
                <!-- Chat messages go here -->
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="support-input" class="auth-input" style="margin:0;" placeholder="Type a message...">
                <button class="btn btn-blue" style="padding:0 15px;" onclick="sendSupportMessage()">‚û§</button>
            </div>
            <button onclick="closeModals()" style="background:none; border:none; color:#666; width:100%; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div class="container">
        <div style="text-align:center; font-weight: bold; color: var(--neon-blue); margin-bottom:15px; font-size:1.5rem; text-shadow: 0 0 10px var(--neon-blue);">NEON SLOTS</div>

        <div class="top-nav">
            <div class="user-badge">
                <button onclick="logout()" style="background:none; border:1px solid var(--danger); color:var(--danger); padding:4px 12px; border-radius:4px; cursor:pointer;">Logout</button>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="openBonusModal()" style="background:linear-gradient(45deg, #ffd700, #ff9f00); border:none; color:black; font-weight:bold; padding:4px 12px; border-radius:15px; cursor:pointer; font-size:0.8rem;">üéÅ Bonus</button>
                <button onclick="openReferModal()" style="background:linear-gradient(45deg, #2ed573, #7bed9f); border:none; color:black; font-weight:bold; padding:4px 12px; border-radius:15px; cursor:pointer; font-size:0.8rem;">üë• Refer</button>
                <button onclick="openModal('support-modal')" style="background:none; border:1px solid var(--success); color:var(--success); padding:3px 10px; border-radius:15px; cursor:pointer; font-size:0.8rem;">üéß Support</button>
            </div>
        </div>

        <!-- Updated Bank Header with TOTAL BALANCE label -->
        <div class="bank-header">
            <div style="flex: 1;">
                <div style="font-size: 0.7rem; color: #888; margin-bottom: 5px;">TOTAL BALANCE</div>
                <div class="bal-val">‚Çπ<span id="balance">0</span></div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button class="btn" style="background: var(--success); padding: 6px 12px; font-size: 0.7rem;" onclick="openModal('deposit-modal')">DEPOSIT</button>
                <button class="btn" style="background: var(--danger); padding: 6px 12px; font-size: 0.7rem;" onclick="openModal('withdraw-modal')">WITHDRAW</button>
            </div>
        </div>

        <div class="announcement-bar"><div class="marquee" id="marquee-text">Triple 7s payout 50x ‚Ä¢ 3+ Scatter Symbols (üé∞) trigger 10 FREE SPINS!</div></div>

        <div id="msg">Ready to Spin?</div>

        <div class="slot-machine" id="machine-body">
            <div class="reel" id="r0"><div class="cell" id="c0">üçí</div><div class="cell" id="c3">üîî</div><div class="cell" id="c6">üíé</div></div>
            <div class="reel" id="r1"><div class="cell" id="c1">7Ô∏è‚É£</div><div class="cell" id="c4">üçã</div><div class="cell" id="c7">üîî</div></div>
            <div class="reel" id="r2"><div class="cell" id="c2">üçí</div><div class="cell" id="c5">üíé</div><div class="cell" id="c8">7Ô∏è‚É£</div></div>
        </div>

        <div class="controls">
            <div class="bet-container">
                <span>BET:</span>
                <div>
                    <button onclick="adjustBet(-5)" style="background:#333; color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">-</button>
                    <input type="number" id="betAmt" value="10" readonly style="width: 50px; background:transparent; color:var(--gold); border:none; text-align:center; font-weight:bold; font-size:1.1rem;">
                    <button onclick="adjustBet(5)" style="background:#333; color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">+</button>
                </div>
                <div id="free-spins-indicator" class="hidden" style="color: var(--free-spin); font-weight: bold; font-size: 0.9rem;">FREE SPIN ACTIVE</div>
            </div>
            <button class="btn btn-spin" id="spinBtn" onclick="play()">SPIN</button>
            <button class="btn btn-auto" id="autoBtn" onclick="toggleAuto()">AUTO</button>
        </div>

        <div class="history-box">
            <h3 style="font-size: 0.9rem; color: #888;">ACTIVITY LOG</h3>
            <div class="history-list" id="history"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyClBohbm2-pReGrbNMsm7ttDvwM2wEIfEo",
            authDomain: "miner-5939b.firebaseapp.com",
            databaseURL: "https://miner-5939b-default-rtdb.firebaseio.com",
            projectId: "miner-5939b",
            storageBucket: "miner-5939b.firebasestorage.app",
            messagingSenderId: "936240933139",
            appId: "1:936240933139:web:fe877e387fc82951d552e6",
            measurementId: "G-Z46V1K2XGN"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const firebaseStatus = document.getElementById('firebase-status');
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                firebaseStatus.textContent = 'Online';
                firebaseStatus.className = 'connection-status connection-online';
            } else {
                firebaseStatus.textContent = 'Offline';
                firebaseStatus.className = 'connection-status connection-offline';
            }
        });

        // FIXED: Deposit Offer Listener
        database.ref('settings/greedyOffer').on('value', snap => {
            const offerText = snap.val();
            const offerElement = document.getElementById('greedy-offer-text');
            
            if(offerText && offerText.trim() !== "") {
                offerElement.innerText = offerText;
                offerElement.style.display = 'block';
            } else {
                offerElement.style.display = 'none';
            }
        });

        // Global Announcement Listener
        database.ref('settings/announcement').on('value', snap => {
            const txt = snap.val();
            if(txt && txt.trim() !== "") {
                document.getElementById('marquee-text').innerText = txt;
            }
        });

        let onlineCount = 24839;
        const countEl = document.getElementById('live-count');
        setInterval(() => {
            const change = Math.floor(Math.random() * 41) - 15;
            onlineCount += change;
            if(onlineCount < 20000) onlineCount = 24000;
            if(onlineCount > 35000) onlineCount = 24000;
            countEl.innerText = onlineCount.toLocaleString();
        }, 3500);

        let isLoginMode = true;
        let currentUserPhone = localStorage.getItem('active_session');
        let userData = {};
        let activeComplaintType = "";
        
        // Payment tracking global vars
        let paymentCheckStartTime = 0;
        let paymentPageLeft = false;
        let paymentAbortedQuickReturn = false;

        const symbols = ['üçí', 'üçã', 'üîî', 'üíé', '7Ô∏è‚É£', 'üé∞'];
        const payouts = {'üçí': 2, 'üçã': 3, 'üîî': 6, 'üíé': 12, '7Ô∏è‚É£': 50, 'üé∞': 0}; 
        const paylines = [[0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]];
        
        let isRunning = false;
        let isAuto = false;
        let freeSpinsRemaining = 0;
        let isFreeSpinActive = false;
        let freeSpinWinMultiplier = 2;

        // Listener for User Data (Live Updates)
        function listenToUser(phone) {
            database.ref('users/' + phone).on('value', snapshot => {
                const data = snapshot.val();
                if(data) {
                    userData = data;
                    
                    // Suspension Check
                    if(userData.isSuspended) {
                        document.getElementById('suspend-modal').classList.remove('hidden');
                        document.getElementById('suspend-msg').innerText = userData.suspendMessage || "Account Suspended";
                        isRunning = false; isAuto = false;
                    } else {
                        document.getElementById('suspend-modal').classList.add('hidden');
                    }

                    // Calculate combined balance for home screen
                    const walletBalance = userData.balance || 0;
                    const withdrawableBalance = userData.withdrawableBalance || 0;
                    const combinedBalance = walletBalance + withdrawableBalance;
                    
                    // Update main display with combined balance (now labeled as TOTAL BALANCE)
                    document.getElementById('balance').innerText = combinedBalance.toLocaleString('en-IN');
                    
                    // Update withdraw modal balances (keep separate for modal)
                    document.getElementById('withdraw-wallet-balance').innerText = walletBalance.toLocaleString('en-IN');
                    document.getElementById('withdraw-available-balance').innerText = withdrawableBalance.toLocaleString('en-IN');

                    // History (Logs)
                    if (userData.history) {
                        const historyArray = Object.entries(userData.history).map(([key, val]) => val);
                        historyArray.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
                        renderHistory(historyArray);
                        renderSpecificHistory(historyArray, 'deposit', 'deposit-history');
                        renderSpecificHistory(historyArray, 'withdraw', 'withdraw-history');
                        renderSupportChat(historyArray);
                    } else {
                         document.getElementById('history').innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No activity yet</div>';
                    }
                    
                    // Free Spins sync
                    if(userData.freeSpinsRemaining !== undefined) {
                        freeSpinsRemaining = userData.freeSpinsRemaining;
                        updateFreeSpinsCounter();
                    }
                }
            });
        }

        async function saveUserToFirebase(phone, data) {
            await database.ref('users/' + phone).set(data);
            return true;
        }

        async function loadUserFromFirebase(phone) {
            const snapshot = await database.ref('users/' + phone).once('value');
            return snapshot.val();
        }

        async function updateUserBalance(phone, newBalance) {
            await database.ref('users/' + phone + '/balance').set(newBalance);
        }
        
        async function updateUserWithdrawableBalance(phone, newWithdrawableBalance) {
            await database.ref('users/' + phone + '/withdrawableBalance').set(newWithdrawableBalance);
        }

        async function addHistoryToFirebase(phone, historyItem) {
            const historyRef = database.ref('users/' + phone + '/history');
            await historyRef.push({
                ...historyItem,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        async function saveComplaintToFirebase(phone, complaintData) {
            const complaintsRef = database.ref('users/' + phone + '/history').push();
            await complaintsRef.set({
                ...complaintData,
                text: `COMPLAINT (${complaintData.type}): ${complaintData.description}`,
                category: complaintData.type,
                userPhone: phone,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending',
                time: new Date().toLocaleTimeString()
            });
            return true;
        }

        function showStatus(msg, type = 'success') {
            const container = document.getElementById('status-container');
            const div = document.createElement('div');
            div.className = 'status-popup';
            div.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
            div.innerText = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
        
        function showFreeSpinsPopup(message) {
            const popup = document.getElementById('free-spins-popup');
            popup.textContent = message;
            popup.classList.remove('hidden');
            setTimeout(() => popup.classList.add('hidden'), 3000);
        }
        
        function updateFreeSpinsCounter() {
            const counter = document.getElementById('free-spins-counter');
            const countElement = document.getElementById('free-spins-count');
            const indicator = document.getElementById('free-spins-indicator');
            
            if (freeSpinsRemaining > 0) {
                countElement.textContent = freeSpinsRemaining;
                counter.classList.remove('hidden');
                indicator.classList.remove('hidden');
            } else {
                counter.classList.add('hidden');
                indicator.classList.add('hidden');
            }
        }

        function openModal(id) { 
            if(id === 'withdraw-modal' && userData.bankDetails) {
                document.getElementById('wit-holder').value = userData.bankDetails.holder || "";
                document.getElementById('wit-bank').value = userData.bankDetails.bank || "";
                document.getElementById('wit-acc').value = userData.bankDetails.acc || "";
                document.getElementById('wit-ifsc').value = userData.bankDetails.ifsc || "";
            }
            document.getElementById(id).classList.remove('hidden'); 
        }

        function closeModals() { 
            document.querySelectorAll('.modal').forEach(m => {
                if(!m.classList.contains('modal-suspension')) m.classList.add('hidden');
            });
        }

        function setAmt(inputId, val) { document.getElementById(inputId).value = val; }

        function adjustBet(val) {
            const input = document.getElementById('betAmt');
            let newVal = parseInt(input.value) + val;
            if (newVal >= 5 && newVal <= 500) input.value = newVal;
        }

        function verifySecurity(phoneId, passId) {
            const ph = document.getElementById(phoneId).value;
            const ps = document.getElementById(passId).value;
            if (ph !== currentUserPhone || ps !== userData.pass) {
                showStatus("Security verification failed!", "err");
                return false;
            }
            return true;
        }

        async function triggerPayment(method) {
            if (!verifySecurity('dep-sec-phone', 'dep-sec-pass')) return;
            const amt = parseInt(document.getElementById('dep-amt-input').value);
            if (amt < 10) return showStatus("Min deposit ‚Çπ10", "err");
            
            if (method === 'Superpay') {
                return showStatus("Superpay is currently Under Maintenance", "err");
            }

            if (method === 'UPI' || method === 'Paytm') {
                paymentCheckStartTime = Date.now();
                paymentPageLeft = false;
                paymentAbortedQuickReturn = false;

                const note = `Neon ${currentUserPhone}`;
                const upiLink = `upi://pay?pa=darpangohain800@oksbi&pn=NeonSlots&am=${amt}&tn=${encodeURIComponent(note)}&cu=INR`;
                
                window.location.href = upiLink;

                const pendingItem = {
                    text: `DEPOSIT PROCESSING: <span class="win-amount">‚Çπ${amt}</span> via ${method}`,
                    type: 'warning', 
                    category: 'deposit', 
                    status: 'processing',
                    time: new Date().toLocaleTimeString()
                };

                await addHistoryToFirebase(currentUserPhone, pendingItem);
                
                closeModals();
                showStatus(`Redirecting... Amount will be credited in 1.5 minutes automatically.`);

                setTimeout(async () => {
                    if (!paymentPageLeft || paymentAbortedQuickReturn) {
                        await addHistoryToFirebase(currentUserPhone, {
                            text: `DEPOSIT FAILED: <span class="win-amount">‚Çπ${amt}</span>. Transaction cancelled or timed out.`,
                            type: 'danger',
                            category: 'deposit',
                            status: 'rejected',
                            time: new Date().toLocaleTimeString()
                        });
                        showStatus("Deposit Failed: Payment not completed.");
                        return;
                    }

                    if(currentUserPhone) {
                        const currentData = await loadUserFromFirebase(currentUserPhone);
                        if(currentData) {
                            const newBalance = (currentData.balance || 0) + amt;
                            // Deposit adds to Wallet Balance only
                            
                            await database.ref('users/' + currentUserPhone + '/balance').set(newBalance);
                            
                            const successItem = {
                                text: `DEPOSIT RECEIVED: <span class="win-amount">‚Çπ${amt}</span> via ${method}`,
                                type: 'success',
                                category: 'deposit',
                                status: 'approved',
                                time: new Date().toLocaleTimeString()
                            };
                            
                            await addHistoryToFirebase(currentUserPhone, successItem);
                            showStatus(`‚Çπ${amt} Credited Successfully to Wallet!`);
                        }
                    }
                }, 90000);
            }
        }

        async function triggerWithdraw() {
            if (!verifySecurity('wit-sec-phone', 'wit-sec-pass')) return;
            const amt = parseInt(document.getElementById('wit-amt-input').value);
            const holder = document.getElementById('wit-holder').value;
            const bank = document.getElementById('wit-bank').value;
            const acc = document.getElementById('wit-acc').value;
            const ifsc = document.getElementById('wit-ifsc').value;

            const minBal = userData.minBalance || 0;
            const maxBal = userData.maxBalance || 1000000;
            const withdrawableBalance = userData.withdrawableBalance || 0;

            if (!holder || !bank || !acc || !ifsc) return showStatus("Fill all bank details", "err");
            if (amt < 110) return showStatus("Min withdrawal ‚Çπ110", "err");
            if (amt > withdrawableBalance) return showStatus("Withdrawable balance insufficient", "err");

            // Check TOTAL BALANCE (Wallet + Withdrawable) against limits
            const walletBalance = userData.balance || 0;
            const totalBalance = walletBalance + withdrawableBalance;
            
            if (totalBalance < minBal || totalBalance > maxBal) {
                return showStatus("Turnover requirement not met. Please continue playing.", "err");
            }

            // Withdraw only from withdrawable balance
            const newWithdrawable = withdrawableBalance - amt;
            
            await database.ref('users/' + currentUserPhone + '/bankDetails').set({ holder, bank, acc, ifsc });
            await database.ref('users/' + currentUserPhone + '/withdrawableBalance').set(newWithdrawable);

            await addHistoryToFirebase(currentUserPhone, {
                text: `WITHDRAW REQUEST: <span class="win-amount">‚Çπ${amt}</span>`,
                type: 'danger', category: 'withdraw', status: 'pending', time: new Date().toLocaleTimeString()
            });
            
            closeModals();
            showStatus("Withdrawal Submitted! Status: PENDING");
        }

        // Other functions remain the same...
        function openComplaint(type) {
            activeComplaintType = type;
            document.getElementById('complaint-type-label').innerText = `Reporting issue with: ${type.toUpperCase()}`;
            document.getElementById('utr-container').classList.remove('hidden');
            openModal('complaint-modal');
        }

        async function submitComplaint() {
            const ref = document.getElementById('complaint-ref').value;
            const desc = document.getElementById('complaint-text').value;
            if(!ref) return showStatus("Please provide UTR", "err");
            if(!desc) return showStatus("Please describe the issue", "err");
            
            await saveComplaintToFirebase(currentUserPhone, {
                type: activeComplaintType,
                reference: ref,
                description: desc
            });
            closeModals();
            showStatus("Complaint Logged. Status: PROCESSING");
        }

        async function sendSupportMessage() {
            const inp = document.getElementById('support-input');
            const msg = inp.value.trim();
            if(!msg) return;
            
            await addHistoryToFirebase(currentUserPhone, {
                text: `User: ${msg}`,
                type: 'support_msg',
                category: 'support',
                time: new Date().toLocaleTimeString()
            });
            inp.value = '';
        }

        // --- DAILY BONUS LOGIC ---
        function openBonusModal() {
            const grid = document.getElementById('bonus-grid-container');
            const btn = document.getElementById('claim-bonus-btn');
            grid.innerHTML = '';
            
            const lastDate = userData.lastBonusDate || "";
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            let streak = userData.bonusStreak || 0;
            
            if (lastDate !== today && lastDate !== yesterday) {
                streak = 0;
            }
            
            const canClaim = (lastDate !== today);
            
            for(let i=1; i<=7; i++) {
                let statusClass = "";
                let badge = "";
                
                if (i <= streak) {
                    statusClass = "claimed";
                    badge = `<div class="claimed-badge">‚úî</div>`;
                } else if (i === streak + 1) {
                    statusClass = "active";
                    if(!canClaim) statusClass = "locked";
                } else {
                    statusClass = "locked";
                }
                
                if(lastDate === today && i === streak) {
                     statusClass = "claimed";
                }
                
                grid.innerHTML += `
                    <div class="day-card ${statusClass}">
                        ${badge}
                        <div class="day-num">Day ${i}</div>
                        <div class="day-icon">üí∞</div>
                        <div class="day-rew">‚Çπ10</div>
                    </div>
                `;
            }
            
            if(canClaim) {
                btn.innerText = "CLAIM BONUS";
                btn.disabled = false;
            } else {
                btn.innerText = "COME BACK TOMORROW";
                btn.disabled = true;
            }
            
            openModal('bonus-modal');
        }

        async function claimDailyBonus() {
            const today = new Date().toDateString();
            const lastDate = userData.lastBonusDate || "";
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if(lastDate === today) return showStatus("Already claimed today!", "err");
            
            let streak = userData.bonusStreak || 0;
            if(lastDate !== yesterday) streak = 0;
            
            if(streak >= 7) streak = 0;
            streak++;
            
            // Apply updates to Wallet Balance only (not withdrawable balance)
            const newBalance = (userData.balance || 0) + 10;
            
            await database.ref('users/' + currentUserPhone).update({
                balance: newBalance,
                lastBonusDate: today,
                bonusStreak: streak
            });
            
            await addHistoryToFirebase(currentUserPhone, {
                text: `DAILY BONUS: <span class="win-amount">‚Çπ10</span> (Day ${streak})`,
                type: 'success', time: new Date().toLocaleTimeString()
            });
            
            showStatus(`Day ${streak} Claimed! ‚Çπ10 Added to Wallet.`);
            closeModals();
        }

        // --- REFERRAL LOGIC ---
        function generateReferralCode() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const nums = "0123456789";
            let code = "";
            for(let i=0; i<4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            for(let i=0; i<4; i++) code += nums.charAt(Math.floor(Math.random() * nums.length));
            for(let i=0; i<4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        function openReferModal() {
            if(!userData.referralCode) {
                const newCode = generateReferralCode();
                userData.referralCode = newCode;
                database.ref('users/' + currentUserPhone + '/referralCode').set(newCode);
                database.ref('referrals/' + newCode).set(currentUserPhone);
            }
            document.getElementById('my-referral-code').innerText = userData.referralCode;
            openModal('refer-modal');
        }

        function copyReferral() {
            const code = document.getElementById('my-referral-code').innerText;
            navigator.clipboard.writeText(code);
            document.getElementById('copy-msg').innerText = "COPIED!";
            setTimeout(() => document.getElementById('copy-msg').innerText = "Tap code to copy", 2000);
        }

        function shareToWhatsapp() {
            const code = userData.referralCode || "NEONWIN";
            const link = "https://ninjaclubapp.github.io/earn-more/new%20slot.html";
            const text = `ü§ë *FREE ‚Çπ50 CASH BONUS!* ü§ë\n\nSign up on Neon Slots now using my code *${code}* and get instant ‚Çπ25 + ‚Çπ25 Welcome Bonus! üé∞\n\nüëá Click here to win big:\n${link}`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? 'VIP MEMBER ACCESS' : 'CLAIM NEW ACCOUNT';
            document.getElementById('auth-toggle-text').innerText = isLoginMode ? 'CLAIM REGISTRATION BONUS NOW' : 'ALREADY A MEMBER? LOGIN';
            
            const referInput = document.getElementById('auth-referral');
            if(isLoginMode) referInput.classList.add('hidden');
            else referInput.classList.remove('hidden');
        }

        async function handleAuth() {
            const phone = document.getElementById('auth-phone').value;
            const pass = document.getElementById('auth-pass').value;
            if (phone.length !== 10) return showStatus("Enter 10-digit phone", "err");
            
            if (isLoginMode) {
                const data = await loadUserFromFirebase(phone);
                if (data && data.pass === pass) loginUser(phone, data);
                else showStatus("Invalid Credentials", "err");
            } else {
                const existing = await loadUserFromFirebase(phone);
                if (existing) return showStatus("User already exists", "err");
                
                let referCodeInput = document.getElementById('auth-referral').value.trim().toUpperCase();
                let startBal = 25;
                let startWithdrawable = 0; // New users start with 0 withdrawable balance
                let referrerPhone = null;
                const newReferCode = generateReferralCode();
                
                if (referCodeInput.length === 12) {
                    const referrerSnap = await database.ref('referrals/' + referCodeInput).once('value');
                    referrerPhone = referrerSnap.val();
                    
                    if (referrerPhone) {
                        startBal += 25;
                        // Referral bonus goes to Wallet Balance only
                    }
                }

                const newUser = {
                    pass, 
                    balance: startBal,
                    withdrawableBalance: startWithdrawable, // Start with 0 withdrawable balance
                    history: [], 
                    bankDetails: null,
                    minBalance: 0, 
                    maxBalance: 1000000,
                    bonusStreak: 0, 
                    lastBonusDate: "",
                    referralCode: newReferCode,
                    createdAt: new Date().toISOString()
                };
                
                if(startBal > 25) {
                     newUser.history.push({
                        text: `WELCOME + REFERRAL BONUS: <span class="win-amount">‚Çπ${startBal}</span>`,
                        type: 'success', 
                        timestamp: firebase.database.ServerValue.TIMESTAMP, 
                        time: new Date().toLocaleTimeString()
                    });
                }

                if(await saveUserToFirebase(phone, newUser)) {
                    database.ref('referrals/' + newReferCode).set(phone);
                    
                    if (referrerPhone) {
                         const referrerRef = database.ref('users/' + referrerPhone);
                         // Referral reward goes to Wallet Balance only
                         await referrerRef.child('balance').transaction((currentBal) => {
                             return (currentBal || 0) + 25;
                         });
                         
                         await addHistoryToFirebase(referrerPhone, {
                            text: `REFERRAL REWARD: <span class="win-amount">‚Çπ25</span> (User ${phone.substr(0,4)}...)`,
                            type: 'success', 
                            category: 'referral', 
                            time: new Date().toLocaleTimeString()
                        });
                    }

                    loginUser(phone, newUser);
                } else {
                    showStatus("Registration failed", "err");
                }
            }
        }

        function loginUser(phone, data) {
            currentUserPhone = phone;
            userData = data;
            localStorage.setItem('active_session', phone);
            document.getElementById('auth-screen').classList.add('hidden');
            listenToUser(phone);
        }

        function logout() { 
            localStorage.removeItem('active_session'); 
            location.reload(); 
        }

        function renderHistory(items) {
            const h = document.getElementById('history');
            const displayItems = items.filter(i => i.type !== 'support_msg' && i.type !== 'info').slice(0, 50); 
            
            if (displayItems.length === 0) {
                 h.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No activity yet</div>';
                 return;
            }

            h.innerHTML = displayItems.map(item => `
                <div class="history-item">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:var(--${item.type === 'success' ? 'success' : item.type === 'danger' ? 'danger' : (item.type === 'warning' ? 'warning' : (item.type === 'freespin' ? 'free-spin' : 'neon-blue'))})">
                            ${item.text}
                        </span>
                        <span style="color:#555; font-size:0.7rem;">${item.time}</span>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        ${item.status ? `<span class="status-tag tag-${item.status}">${item.status}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderSpecificHistory(items, category, elementId) {
            const el = document.getElementById(elementId);
            const filtered = items.filter(i => i.category === category).slice(0, 10);
            
            if(filtered.length === 0) {
                el.innerHTML = '<div style="color:#666; text-align:center; font-size:0.7rem;">No records</div>';
                return;
            }

            el.innerHTML = filtered.map(item => `
                <div class="mini-item">
                    <div style="display:flex; justify-content:space-between;">
                        <span>${item.time}</span>
                        <span style="color:${item.status === 'approved' ? 'var(--success)' : 'var(--warning)'}">${(item.status || 'DONE').toUpperCase()}</span>
                    </div>
                    <div style="color:white;">${item.text}</div>
                </div>
            `).join('');
        }

        function renderSupportChat(items) {
            const el = document.getElementById('support-chat-area');
            const chatItems = items.filter(i => i.category === 'support' || i.type === 'info' || i.type === 'support_msg').reverse();
            
            el.innerHTML = chatItems.map(item => {
                const isAdmin = item.text.startsWith('Neon');
                return `
                    <div style="align-self: ${isAdmin ? 'flex-start' : 'flex-end'}; max-width: 80%;">
                        <div style="background: ${isAdmin ? '#222' : 'var(--neon-blue)'}; color: ${isAdmin ? '#fff' : '#000'}; padding: 8px; border-radius: 8px; font-size: 0.85rem;">
                            ${item.text}
                        </div>
                        <div style="font-size: 0.6rem; color: #666; text-align: ${isAdmin ? 'left' : 'right'}; margin-top: 2px;">${item.time}</div>
                    </div>
                `;
            }).join('');
            el.scrollTop = el.scrollHeight;
        }

        function toggleAuto() {
            isAuto = !isAuto;
            const btn = document.getElementById('autoBtn');
            btn.classList.toggle('active', isAuto);
            btn.innerText = isAuto ? "STOP" : "AUTO";
            if(isAuto && !isRunning) {
                play();
            }
        }

        // Modified Game Engine for combined balance system
        async function play() {
            if(isRunning) return;
            if(userData.isSuspended) return;

            const bet = parseInt(document.getElementById('betAmt').value);
            
            const minBal = userData.minBalance || 0;
            const maxBal = userData.maxBalance || 1000000;
            const buffer = 50;

            if (freeSpinsRemaining > 0) {
                isFreeSpinActive = true;
                freeSpinsRemaining--;
                database.ref('users/' + currentUserPhone + '/freeSpinsRemaining').set(freeSpinsRemaining);
                updateFreeSpinsCounter();
            } else {
                // Check if user has enough total balance to bet
                const walletBalance = userData.balance || 0;
                const withdrawableBalance = userData.withdrawableBalance || 0;
                const totalAvailable = walletBalance + withdrawableBalance;
                
                if(bet > totalAvailable) {
                    showStatus("Insufficient Balance", "err");
                    if(isAuto) toggleAuto();
                    return;
                }
                
                isFreeSpinActive = false;
                
                // Deduct bet from Wallet Balance first, then from Withdrawable Balance
                let newWalletBalance = walletBalance;
                let newWithdrawableBalance = withdrawableBalance;
                
                if (walletBalance >= bet) {
                    newWalletBalance = walletBalance - bet;
                } else {
                    // Deduct remaining from Withdrawable Balance
                    const remainingFromWallet = bet - walletBalance;
                    newWalletBalance = 0;
                    newWithdrawableBalance = withdrawableBalance - remainingFromWallet;
                }
                
                // Update both balances
                await database.ref('users/' + currentUserPhone + '/balance').set(newWalletBalance);
                await database.ref('users/' + currentUserPhone + '/withdrawableBalance').set(newWithdrawableBalance);
                
                // Update local userData for immediate UI updates
                userData.balance = newWalletBalance;
                userData.withdrawableBalance = newWithdrawableBalance;
            }
            
            isRunning = true;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('msg').innerText = isFreeSpinActive ? `FREE SPIN! (${freeSpinsRemaining} left)` : "Spinning...";

            const adminMode = userData.mode || 'normal'; 
            const adminNextOutcome = userData.nextOutcome; 
            const adminNextAmt = userData.nextOutcomeAmount; 
            const adminNextGrid = userData.nextGrid;

            let outcomeType = 'random'; 
            let targetWin = 0;
            let finalGrid = [];
            let forceWinAmount = -1;

            if (adminNextGrid && Array.isArray(adminNextGrid) && adminNextGrid.length === 9) {
                outcomeType = 'rigged_grid';
                finalGrid = adminNextGrid;
                database.ref('users/' + currentUserPhone).update({ nextGrid: null, nextOutcomeAmount: null, nextOutcome: null });
            } 
            else if (adminNextAmt && adminNextAmt > 0) {
                outcomeType = 'specific';
                targetWin = adminNextAmt;
                database.ref('users/' + currentUserPhone).update({ nextOutcomeAmount: null });
            } 
            else if (adminNextOutcome === 'win' || adminMode === 'force_win') {
                outcomeType = 'force_win';
                if(adminNextOutcome === 'win') database.ref('users/' + currentUserPhone + '/nextOutcome').set(null);
            } else if (adminNextOutcome === 'scatter') {
                outcomeType = 'scatter';
                 database.ref('users/' + currentUserPhone + '/nextOutcome').set(null);
            } else if (adminMode === 'force_loss') {
                outcomeType = 'loss';
            } else {
                // Calculate TOTAL BALANCE (Wallet + Withdrawable) for trap limits
                const walletBalance = userData.balance || 0;
                const withdrawableBalance = userData.withdrawableBalance || 0;
                const totalBalance = walletBalance + withdrawableBalance;

                if (totalBalance <= minBal + buffer) {
                    if (Math.random() < 0.8) {
                        outcomeType = Math.random() < 0.7 ? 'small' : 'medium';
                    } else {
                        outcomeType = 'loss'; 
                    }
                } else if (totalBalance >= maxBal - buffer) {
                    if (Math.random() < 0.9) {
                        outcomeType = 'loss';
                    } else {
                        outcomeType = 'small'; 
                    }
                } else {
                    const rand = Math.random();
                    if (rand < 0.60) outcomeType = 'loss';
                    else if (rand < 0.90) outcomeType = 'small';
                    else if (rand < 0.98) outcomeType = 'medium';
                    else outcomeType = 'big';
                }
            }

            if (outcomeType === 'rigged_grid') {
                const calc = calculateWin(finalGrid, bet, isFreeSpinActive);
                forceWinAmount = calc.winAmount;
            
            } else if (outcomeType === 'specific') {
                finalGrid = ['7Ô∏è‚É£', '7Ô∏è‚É£', '7Ô∏è‚É£', 'üçí', 'üçã', 'üîî', 'üíé', '7Ô∏è‚É£', 'üîî'];
                forceWinAmount = targetWin;

            } else if (outcomeType === 'scatter') {
                finalGrid = ['üé∞', 'üçí', 'üçã', 'üé∞', '7Ô∏è‚É£', 'üîî', 'üíé', 'üé∞', 'üçí'];

            } else if (outcomeType === 'force_win' || outcomeType === 'small' || outcomeType === 'medium' || outcomeType === 'big') {
                let attempts = 0;
                let desiredMultMin = 0;
                let desiredMultMax = 0;

                if(outcomeType === 'small') { desiredMultMin = 1; desiredMultMax = 5; } 
                if(outcomeType === 'medium') { desiredMultMin = 6; desiredMultMax = 20; } 
                if(outcomeType === 'big' || outcomeType === 'force_win') { desiredMultMin = 20; desiredMultMax = 100; } 

                while(attempts < 50) {
                    const tempGrid = generateRandomGrid(isFreeSpinActive);
                    const calc = calculateWin(tempGrid, bet, isFreeSpinActive);
                    
                    if (calc.winAmount > 0) {
                        const mult = calc.winAmount / bet;
                        
                        if ((outcomeType === 'force_win' && mult > 0) || (mult >= desiredMultMin && mult <= desiredMultMax)) {
                            // Check if win would exceed max limit based on TOTAL BALANCE
                            const walletBalance = userData.balance || 0;
                            const withdrawableBalance = userData.withdrawableBalance || 0;
                            const currentTotal = walletBalance + withdrawableBalance;
                            
                            if (currentTotal + calc.winAmount > maxBal + (buffer/2)) {
                                if (outcomeType === 'big') outcomeType = 'medium'; 
                                attempts++;
                                continue;
                            }
                            finalGrid = tempGrid;
                            break;
                        }
                    }
                    attempts++;
                }
                if (finalGrid.length === 0) finalGrid = ['üçí', 'üçí', 'üçí', 'üçã', 'üîî', 'üíé', '7Ô∏è‚É£', '7Ô∏è‚É£', 'üîî']; 
            
            } else {
                let attempts = 0;
                while(attempts < 50) {
                    const tempGrid = generateRandomGrid(isFreeSpinActive);
                    const calc = calculateWin(tempGrid, bet, isFreeSpinActive);
                    if (calc.winAmount === 0 && calc.scatters < 3) {
                        finalGrid = tempGrid;
                        break;
                    }
                    attempts++;
                }
                if (finalGrid.length === 0) finalGrid = ['üçí', 'üçã', 'üîî', 'üíé', '7Ô∏è‚É£', 'üçí', 'üîî', 'üíé', '7Ô∏è‚É£']; 
            }

            animateSpin(finalGrid, forceWinAmount, bet);
        }

        function generateRandomGrid(isFree) {
            const res = [];
            for(let i=0; i<9; i++) {
                if (isFree) {
                    const freeSyms = ['üíé', '7Ô∏è‚É£', 'üîî', 'üçí', 'üçã'];
                    res.push(getWeightedSymbol(freeSyms, [0.25, 0.2, 0.2, 0.2, 0.15]));
                } else {
                    res.push(symbols[Math.floor(Math.random() * symbols.length)]);
                }
            }
            return res;
        }

        function getWeightedSymbol(symbols, weights) {
            const total = weights.reduce((a, b) => a + b, 0);
            let r = Math.random() * total;
            for (let i = 0; i < symbols.length; i++) {
                r -= weights[i];
                if (r <= 0) return symbols[i];
            }
            return symbols[symbols.length - 1];
        }

        function animateSpin(finalGrid, forceWinAmount, bet) {
            document.querySelectorAll('.cell').forEach(c => {
                c.classList.remove('winner-cell', 'scatter-cell');
                c.classList.add('spinning');
            });

            setTimeout(() => stopReel([0,3,6], finalGrid), 600);
            setTimeout(() => stopReel([1,4,7], finalGrid), 1000);
            setTimeout(() => {
                stopReel([2,5,8], finalGrid);
                finishSpin(finalGrid, forceWinAmount, bet);
            }, 1400);
        }

        function stopReel(indices, grid) {
            indices.forEach(i => {
                const el = document.getElementById(`c${i}`);
                el.classList.remove('spinning');
                el.innerText = grid[i];
            });
        }

        function calculateWin(grid, bet, isFree) {
            let totalWin = 0;
            let scatterCount = 0;
            const winningLines = [];

            grid.forEach(s => { if(s === 'üé∞') scatterCount++; });

            paylines.forEach(line => {
                const [a, b, c] = line;
                if(grid[a] === grid[b] && grid[b] === grid[c] && grid[a] !== 'üé∞') {
                    const mult = payouts[grid[a]] || 0;
                    totalWin += bet * mult * (isFree ? 2 : 1);
                    winningLines.push(line);
                }
            });

            return { winAmount: totalWin, scatters: scatterCount, winningLines };
        }

        async function finishSpin(grid, forceWinAmount, bet) {
            const calc = calculateWin(grid, bet, isFreeSpinActive);
            let realWin = forceWinAmount > -1 ? forceWinAmount : calc.winAmount; 
            
            if(currentUserPhone) {
                database.ref('users/' + currentUserPhone + '/lastGrid').set(grid);
            }

            calc.winningLines.forEach(line => {
                line.forEach(idx => document.getElementById(`c${idx}`).classList.add('winner-cell'));
            });

            if(calc.scatters >= 3 && !isFreeSpinActive) {
                freeSpinsRemaining += 10;
                database.ref('users/' + currentUserPhone + '/freeSpinsRemaining').set(freeSpinsRemaining);
                grid.forEach((s, i) => { if(s === 'üé∞') document.getElementById(`c${i}`).classList.add('scatter-cell'); });
                showFreeSpinsPopup(`üéâ ${calc.scatters} SCATTERS! 10 FREE SPINS!`);
                await addHistoryToFirebase(currentUserPhone, {
                    text: `üé∞ SCATTER BONUS: <span class="free-spin-text">10 FREE SPINS!</span>`,
                    type: 'freespin', time: new Date().toLocaleTimeString()
                });
            }

            if(realWin > 0) {
                // Winnings go to Withdrawable Balance only
                const currentWithdrawableBalance = userData.withdrawableBalance || 0;
                const newWithdrawableBalance = currentWithdrawableBalance + realWin;
                
                await database.ref('users/' + currentUserPhone + '/withdrawableBalance').set(newWithdrawableBalance);
                
                const msgEl = document.getElementById('msg');
                const winRatio = realWin / bet;

                if (winRatio >= 20) {
                    msgEl.innerHTML = `<span class="jackpot-text">JACKPOT!! ‚Çπ${realWin}</span>`;
                } else if (winRatio >= 5) {
                    msgEl.innerHTML = `<span class="big-win-text">BIG WIN! ‚Çπ${realWin}</span>`;
                } else {
                    msgEl.innerHTML = `<span class="win-message">WIN: ‚Çπ${realWin}!</span>`;
                }

                if (!isFreeSpinActive) {
                    await addHistoryToFirebase(currentUserPhone, {
                        text: `SLOT WIN: <span class="win-amount">‚Çπ${realWin}</span> (Added to Withdrawable Balance)`,
                        type: 'success', time: new Date().toLocaleTimeString()
                    });
                } else {
                     await addHistoryToFirebase(currentUserPhone, {
                        text: `FREE SPIN WIN: <span class="win-amount">‚Çπ${realWin}</span> (Added to Withdrawable Balance)`,
                        type: 'freespin', time: new Date().toLocaleTimeString()
                    });
                }
            } else {
                 if(!isFreeSpinActive && calc.scatters < 3) document.getElementById('msg').innerText = "Try Again!";
            }

            isRunning = false;
            document.getElementById('spinBtn').disabled = false;
            updateFreeSpinsCounter();
            
            // Check total available balance (Wallet + Withdrawable) for auto spin
            const walletBalance = userData.balance || 0;
            const withdrawableBalance = userData.withdrawableBalance || 0;
            const totalAvailable = walletBalance + withdrawableBalance;
            
            if(isAuto && !userData.isSuspended) {
                if(totalAvailable >= parseInt(document.getElementById('betAmt').value)) {
                    setTimeout(play, 1000);
                } else {
                    toggleAuto(); 
                }
            }
            if(freeSpinsRemaining > 0 && !isAuto && !userData.isSuspended) setTimeout(play, 2000);
        }

        // --- PAYMENT TRACKING LISTENER ---
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden') {
                if (paymentCheckStartTime > 0) paymentPageLeft = true;
            } else if (document.visibilityState === 'visible') {
                if (paymentCheckStartTime > 0 && paymentPageLeft) {
                    const timeElapsed = Date.now() - paymentCheckStartTime;
                    if (timeElapsed < 10000) {
                        paymentAbortedQuickReturn = true;
                    }
                }
            }
        });

        window.onload = async function() {
            if (currentUserPhone) {
                const data = await loadUserFromFirebase(currentUserPhone);
                if (data) loginUser(currentUserPhone, data);
                else localStorage.removeItem('active_session');
            }
        };
    </script>
</body>
</html>
